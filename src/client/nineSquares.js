/**<linter>
<lastLinted>12/02/2016 18:14<lastLinted>
<errorCount>286<errorCount>
<errors>
    func-names line 299 : Missing function expression name.
    newline-after-var line 300 : Expected blank line after variable declarations.
    valid-jsdoc line 310 : Missing JSDoc for parameter 'configArray'.
    no-unused-vars line 314 : "startNsWidget" is defined but never used
    no-unused-vars line 316 : "services" is defined but never used
    max-len line 327 : Line 328 exceeds the maximum line length of 80.
    vars-on-top line 327 : All "var" declarations must be at the top of the function scope.
    max-len line 328 : Line 329 exceeds the maximum line length of 80.
    vars-on-top line 328 : All "var" declarations must be at the top of the function scope.
    newline-after-var line 329 : Expected blank line after variable declarations.
    vars-on-top line 329 : All "var" declarations must be at the top of the function scope.
    id-length line 329 : Identifier name 'applicationsWidget' is too long. (> 15)
    no-undef line 329 : "$" is not defined.
    no-undef line 332 : "$" is not defined.
    vars-on-top line 333 : All "var" declarations must be at the top of the function scope.
    no-unused-vars line 333 : "nbrApps" is defined but never used
    no-undef line 337 : "$" is not defined.
    func-names line 337 : Missing function expression name.
    no-undef line 340 : "$" is not defined.
    func-names line 340 : Missing function expression name.
    no-shadow line 340 : "event" is already declared in the upper scope.
    max-len line 341 : Line 342 exceeds the maximum line length of 80.
    no-undef line 341 : "$" is not defined.
    no-undef line 341 : "$" is not defined.
    no-undef line 341 : "$" is not defined.
    vars-on-top line 347 : All "var" declarations must be at the top of the function scope.
    newline-after-var line 347 : Expected blank line after variable declarations.
    no-magic-numbers line 348 : No magic number: 183
    no-magic-numbers line 348 : No magic number: 26
    no-inline-comments line 348 : Unexpected comment inline with code.
    lines-around-comment line 359 : Expected line before comment.
    valid-jsdoc line 405 : Missing JSDoc for parameter 'authName'.
    valid-jsdoc line 405 : Missing JSDoc for parameter 'authServices'.
    newline-after-var line 412 : Expected blank line after variable declarations.
    no-empty line 413 : Empty block statement.
    curly line 415 : Expected { after 'if' condition.
    curly line 417 : Expected { after 'if' condition.
    curly line 419 : Expected { after 'if' condition.
    func-names line 422 : Missing function expression name.
    no-unused-vars line 422 : "data" is defined but never used
    func-names line 425 : Missing function expression name.
    no-inner-declarations line 426 : Move variable declaration to function body root.
    vars-on-top line 426 : All "var" declarations must be at the top of the function scope.
    no-inner-declarations line 427 : Move variable declaration to function body root.
    vars-on-top line 427 : All "var" declarations must be at the top of the function scope.
    newline-after-var line 427 : Expected blank line after variable declarations.
    no-inline-comments line 428 : Unexpected comment inline with code.
    no-inner-declarations line 430 : Move variable declaration to function body root.
    vars-on-top line 430 : All "var" declarations must be at the top of the function scope.
    newline-after-var line 430 : Expected blank line after variable declarations.
    no-magic-numbers line 430 : No magic number: 300000
    no-inline-comments line 432 : Unexpected comment inline with code.
    no-undef line 433 : "$" is not defined.
    func-names line 433 : Missing function expression name.
    no-loop-func line 433 : Don't make functions within a loop
    no-implied-eval line 434 : Implied eval. Consider passing a function instead of a string.
    curly line 439 : Expected { after 'if' condition.
    curly line 441 : Expected { after 'if' condition.
    padded-blocks line 448 : Block must not be padded by blank lines.
    max-len line 460 : Line 461 exceeds the maximum line length of 80.
    newline-after-var line 460 : Expected blank line after variable declarations.
    no-undef line 461 : "$" is not defined.
    func-names line 463 : Missing function expression name.
    newline-after-var line 464 : Expected blank line after variable declarations.
    no-inner-declarations line 466 : Move variable declaration to function body root.
    vars-on-top line 466 : All "var" declarations must be at the top of the function scope.
    no-undef line 466 : "$" is not defined.
    max-len line 467 : Line 468 exceeds the maximum line length of 80.
    vars-on-top line 467 : All "var" declarations must be at the top of the function scope.
    no-inner-declarations line 467 : Move variable declaration to function body root.
    no-extra-parens line 467 : Gratuitous parentheses around expression.
    no-magic-numbers line 467 : No magic number: 99
    max-len line 468 : Line 469 exceeds the maximum line length of 80.
    no-inner-declarations line 468 : Move variable declaration to function body root.
    vars-on-top line 468 : All "var" declarations must be at the top of the function scope.
    newline-after-var line 468 : Expected blank line after variable declarations.
    max-len line 469 : Line 470 exceeds the maximum line length of 80.
    no-inner-declarations line 470 : Move variable declaration to function body root.
    vars-on-top line 470 : All "var" declarations must be at the top of the function scope.
    newline-after-var line 470 : Expected blank line after variable declarations.
    no-undef line 470 : "$" is not defined.
    curly line 471 : Expected { after 'if' condition.
    curly line 473 : Expected { after 'else'.
    func-names line 479 : Missing function expression name.
    no-undef line 485 : "$" is not defined.
    no-undef line 487 : "urlToAppointment" is not defined.
    no-undef line 488 : "urlToAppointment" is not defined.
    func-names line 489 : Missing function expression name.
    newline-after-var line 490 : Expected blank line after variable declarations.
    id-length line 490 : Identifier name 'soonAppointments' is too long. (> 15)
    no-inner-declarations line 492 : Move variable declaration to function body root.
    vars-on-top line 492 : All "var" declarations must be at the top of the function scope.
    no-undef line 492 : "$" is not defined.
    max-len line 493 : Line 494 exceeds the maximum line length of 80.
    vars-on-top line 493 : All "var" declarations must be at the top of the function scope.
    no-inner-declarations line 493 : Move variable declaration to function body root.
    no-extra-parens line 493 : Gratuitous parentheses around expression.
    id-length line 493 : Identifier name 'soonAppointments' is too long. (> 15)
    no-magic-numbers line 493 : No magic number: 99
    no-inner-declarations line 494 : Move variable declaration to function body root.
    vars-on-top line 494 : All "var" declarations must be at the top of the function scope.
    newline-after-var line 494 : Expected blank line after variable declarations.
    max-len line 495 : Line 496 exceeds the maximum line length of 80.
    no-inner-declarations line 496 : Move variable declaration to function body root.
    vars-on-top line 496 : All "var" declarations must be at the top of the function scope.
    newline-after-var line 496 : Expected blank line after variable declarations.
    no-undef line 496 : "$" is not defined.
    curly line 497 : Expected { after 'if' condition.
    curly line 499 : Expected { after 'else'.
    func-names line 505 : Missing function expression name.
    valid-jsdoc line 512 : Missing JSDoc for parameter 'target'.
    valid-jsdoc line 512 : Missing JSDoc for parameter 'service'.
    newline-after-var line 519 : Expected blank line after variable declarations.
    curly line 520 : Expected { after 'if' condition.
    curly line 522 : Expected { after 'if' condition.
    newline-after-var line 524 : Expected blank line after variable declarations.
    vars-on-top line 524 : All "var" declarations must be at the top of the function scope.
    no-redeclare line 524 : "service" is already defined
    func-names line 526 : Missing function expression name.
    no-unused-vars line 526 : "data" is defined but never used
    no-undef line 527 : "applications" is not defined.
    no-undef line 527 : "$" is not defined.
    vars-on-top line 528 : All "var" declarations must be at the top of the function scope.
    newline-after-var line 529 : Expected blank line after variable declarations.
    vars-on-top line 529 : All "var" declarations must be at the top of the function scope.
    no-inner-declarations line 530 : Move variable declaration to function body root.
    vars-on-top line 530 : All "var" declarations must be at the top of the function scope.
    max-len line 532 : Line 533 exceeds the maximum line length of 80.
    no-inner-declarations line 532 : Move variable declaration to function body root.
    vars-on-top line 532 : All "var" declarations must be at the top of the function scope.
    newline-after-var line 532 : Expected blank line after variable declarations.
    curly line 533 : Expected { after 'if' condition.
    no-undef line 534 : "applications" is not defined.
    curly line 535 : Expected { after 'else'.
    no-undef line 536 : "applications" is not defined.
    func-names line 541 : Missing function expression name.
    valid-jsdoc line 547 : Missing JSDoc for parameter 'configArray'.
    valid-jsdoc line 547 : Missing JSDoc for parameter 'iconUrl'.
    newline-after-var line 554 : Expected blank line after variable declarations.
    func-names line 556 : Missing function expression name.
    no-unused-vars line 556 : "data" is defined but never used
    no-undef line 557 : "$" is not defined.
    no-inner-declarations line 558 : Move variable declaration to function body root.
    vars-on-top line 558 : All "var" declarations must be at the top of the function scope.
    no-undef line 558 : "$" is not defined.
    max-len line 559 : Line 560 exceeds the maximum line length of 80.
    vars-on-top line 559 : All "var" declarations must be at the top of the function scope.
    newline-after-var line 559 : Expected blank line after variable declarations.
    no-inner-declarations line 559 : Move variable declaration to function body root.
    func-names line 564 : Missing function expression name.
    newline-after-var line 565 : Expected blank line after variable declarations.
    no-undef line 565 : "$" is not defined.
    padded-blocks line 574 : Block must not be padded by blank lines.
    require-jsdoc line 580 : Missing JSDoc comment.
    no-undef line 583 : "$" is not defined.
    quote-props line 584 : Unquoted property `type` found.
    key-spacing line 584 : Missing space before value for key "type".
    quote-props line 585 : Unquoted property `url` found.
    key-spacing line 585 : Missing space before value for key "url".
    quote-props line 586 : Unquoted property `contentType` found.
    quote-props line 587 : Unquoted property `crossDomain` found.
    quote-props line 588 : Unquoted property `xhrFields` found.
    key-spacing line 588 : Missing space before value for key "xhrFields".
    quote-props line 589 : Unquoted property `withCredentials` found.
    quote-props line 591 : Unquoted property `headers` found.
    quote-props line 596 : Unquoted property `success` found.
    func-names line 596 : Missing function expression name.
    quote-props line 601 : Unquoted property `error` found.
    func-names line 601 : Missing function expression name.
    require-jsdoc line 609 : Missing JSDoc comment.
    no-redeclare line 610 : "maxApps" is already defined
    no-magic-numbers line 610 : No magic number: 9
    id-length line 611 : Identifier name 'applicationsWidget' is too long. (> 15)
    no-undef line 611 : "$" is not defined.
    no-undef line 612 : "$" is not defined.
    no-undef line 613 : "$" is not defined.
    max-len line 614 : Line 615 exceeds the maximum line length of 80.
    newline-after-var line 614 : Expected blank line after variable declarations.
    no-extra-parens line 614 : Gratuitous parentheses around expression.
    no-magic-numbers line 614 : No magic number: 70
    no-magic-numbers line 614 : No magic number: 3
    no-magic-numbers line 614 : No magic number: 6
    no-magic-numbers line 614 : No magic number: 70
    no-magic-numbers line 614 : No magic number: 3
    no-magic-numbers line 614 : No magic number: 6
    no-inline-comments line 614 : Unexpected comment inline with code.
    no-magic-numbers line 615 : No magic number: 6
    lines-around-comment line 619 : Expected line before comment.
    no-inner-declarations line 623 : Move variable declaration to function body root.
    vars-on-top line 623 : All "var" declarations must be at the top of the function scope.
    max-len line 624 : Line 625 exceeds the maximum line length of 80.
    vars-on-top line 624 : All "var" declarations must be at the top of the function scope.
    no-inner-declarations line 624 : Move variable declaration to function body root.
    newline-after-var line 624 : Expected blank line after variable declarations.
    no-undef line 626 : "$" is not defined.
    no-magic-numbers line 627 : No magic number: 10
    no-inline-comments line 627 : Unexpected comment inline with code.
    no-undef line 630 : "appButton" is not defined.
    no-undef line 630 : "$" is not defined.
    func-names line 630 : Missing function expression name.
    no-undef line 633 : "$" is not defined.
    func-names line 633 : Missing function expression name.
    no-shadow line 633 : "event" is already declared in the upper scope.
    max-len line 634 : Line 635 exceeds the maximum line length of 80.
    no-undef line 634 : "$" is not defined.
    no-undef line 634 : "$" is not defined.
    no-undef line 634 : "appButton" is not defined.
    no-undef line 634 : "$" is not defined.
    no-inner-declarations line 638 : Move variable declaration to function body root.
    vars-on-top line 638 : All "var" declarations must be at the top of the function scope.
    newline-after-var line 638 : Expected blank line after variable declarations.
    no-undef line 638 : "appButton" is not defined.
    no-magic-numbers line 639 : No magic number: 183
    no-magic-numbers line 639 : No magic number: 26
    no-inline-comments line 639 : Unexpected comment inline with code.
    func-names line 645 : Missing function expression name.
    newline-after-var line 646 : Expected blank line after variable declarations.
    max-len line 649 : Line 650 exceeds the maximum line length of 80.
    no-magic-numbers line 649 : No magic number: 17
    no-inline-comments line 649 : Unexpected comment inline with code.
    max-len line 657 : Line 658 exceeds the maximum line length of 80.
    no-magic-numbers line 657 : No magic number: 17
    no-inline-comments line 657 : Unexpected comment inline with code.
    padded-blocks line 665 : Block must not be padded by blank lines.
    require-jsdoc line 668 : Missing JSDoc comment.
    id-length line 668 : Identifier name 'updateApplications' is too long. (> 15)
    no-undef line 671 : "$" is not defined.
    no-undef line 675 : "$" is not defined.
    no-inner-declarations line 678 : Move variable declaration to function body root.
    vars-on-top line 678 : All "var" declarations must be at the top of the function scope.
    block-scoped-var line 678 : "i" used outside of binding context.
    block-scoped-var line 678 : "i" used outside of binding context.
    block-scoped-var line 678 : "i" used outside of binding context.
    no-inner-declarations line 679 : Move variable declaration to function body root.
    vars-on-top line 679 : All "var" declarations must be at the top of the function scope.
    block-scoped-var line 679 : "i" used outside of binding context.
    max-len line 680 : Line 681 exceeds the maximum line length of 80.
    no-inner-declarations line 680 : Move variable declaration to function body root.
    vars-on-top line 680 : All "var" declarations must be at the top of the function scope.
    newline-after-var line 680 : Expected blank line after variable declarations.
    vars-on-top line 686 : All "var" declarations must be at the top of the function scope.
    vars-on-top line 687 : All "var" declarations must be at the top of the function scope.
    vars-on-top line 688 : All "var" declarations must be at the top of the function scope.
    id-length line 688 : Identifier name 'zcs_personnelServices' is too long. (> 15)
    camelcase line 688 : Identifier 'zcs_personnelServices' is not in camel case.
    vars-on-top line 689 : All "var" declarations must be at the top of the function scope.
    newline-after-var line 689 : Expected blank line after variable declarations.
    id-length line 689 : Identifier name 'zcs_etudiantServices' is too long. (> 15)
    camelcase line 689 : Identifier 'zcs_etudiantServices' is not in camel case.
    no-inner-declarations line 690 : Move variable declaration to function body root.
    vars-on-top line 690 : All "var" declarations must be at the top of the function scope.
    block-scoped-var line 690 : "i" used outside of binding context.
    no-redeclare line 690 : "i" is already defined
    block-scoped-var line 690 : "i" used outside of binding context.
    block-scoped-var line 690 : "i" used outside of binding context.
    no-inner-declarations line 691 : Move variable declaration to function body root.
    vars-on-top line 691 : All "var" declarations must be at the top of the function scope.
    block-scoped-var line 691 : "i" used outside of binding context.
    vars-on-top line 692 : All "var" declarations must be at the top of the function scope.
    newline-after-var line 692 : Expected blank line after variable declarations.
    no-inner-declarations line 692 : Move variable declaration to function body root.
    camelcase line 694 : Identifier 'zcs_personnelServices' is not in camel case.
    camelcase line 696 : Identifier 'zcs_etudiantServices' is not in camel case.
    no-inner-declarations line 702 : Move variable declaration to function body root.
    vars-on-top line 702 : All "var" declarations must be at the top of the function scope.
    newline-after-var line 702 : Expected blank line after variable declarations.
    no-inline-comments line 703 : Unexpected comment inline with code.
    no-inline-comments line 706 : Unexpected comment inline with code.
    no-undef line 707 : "$" is not defined.
    no-loop-func line 707 : Don't make functions within a loop
    func-names line 707 : Missing function expression name.
    max-len line 708 : Line 709 exceeds the maximum line length of 80.
    curly line 717 : Expected { after 'if' condition.
    max-len line 718 : Line 719 exceeds the maximum line length of 80.
    curly line 718 : Expected { after 'if' condition.
    camelcase line 718 : Identifier 'zcs_personnelServices' is not in camel case.
    id-length line 718 : Identifier name 'zcs_personnelServices' is too long. (> 15)
    max-len line 719 : Line 720 exceeds the maximum line length of 80.
    curly line 719 : Expected { after 'if' condition.
    camelcase line 719 : Identifier 'zcs_etudiantServices' is not in camel case.
    id-length line 719 : Identifier name 'zcs_etudiantServices' is too long. (> 15)
    curly line 720 : Expected { after 'if' condition.
    require-jsdoc line 723 : Missing JSDoc comment.
    id-length line 723 : Identifier name 'checkOngoingAjax' is too long. (> 15)
    newline-after-var line 724 : Expected blank line after variable declarations.
    no-undef line 724 : "$" is not defined.
<errors>
<linter>**/

/*************************************************
--------------------CSS Import--------------------
*************************************************/

[
    "nineSquares.css"
].forEach(function(href){
    var link = document.createElement("link");
    link.rel = "stylesheet";
    link.href = href;
    document.head.appendChild(link);
});

/*******************************************
--------------------Main--------------------
*******************************************/

/**
* Append a 9 squares button and a list of icons in the #applications-widget div
* @configArray : JSON file that is used to configure the widget
**/
function startNsWidget(configArray){
    var apps = configArray.apps;
    var services = configArray.services;
    var maxApps = configArray.maxApps;
    var mainIconUrl = configArray.mainIconUrl;
    var loadingIconUrl = configArray.loadingIconUrl;

    // We need maxApps and ajaxCount to be global :/
    window.nswidget = {};
    window.nswidget.maxApps = maxApps;
    window.nswidget.ajaxCount = 0;

    // First we add the 9 squares button, then the block we'll put the apps in. The applications block is not visible at first
    var appButton = "<div class=\"icon app-button\" style=\"margin-left:500px;background-image: url('" + mainIconUrl + "');\"><span class=\"loader\"><img src='" + loadingIconUrl + "' style=\"display:none;\"></span></div>";
    var applications = "<div class=\"applications\" style=\"display:none;\"></div>";
    var applicationsWidget = $("#ns-widget");
    applicationsWidget.append(appButton);
    applicationsWidget.append(applications);
    applications = $("#ns-widget .applications");
    var nbrApps = apps.length;

    // We add a click event on the button : toggle the applications block
    // We also make the applications block disapear if we click outside of it
    appButton = $("#ns-widget .app-button").click(function(){
        applications.toggle(0);
    });
    $(document).on("click", function(event){
        if(!$(event.target).closest(applications).length && !$(event.target).closest(appButton).length && !$(event.target).closest(".plus-button").length){
            applications.hide(0);
        }
    });

    // We put the applications block under the button
    var offset = appButton.offset().left;
    applications.css("margin-left", offset - 183 + 26); // button x coordinate - (applications block size)/2 + (button size/2)
    /*
    // We create the clickable icons with the configuration JSON file
    for(var i=0; i<nbrApps; i++){
        var app = apps[i];
        var appTag = '<a class="vignette" title="'+app.title+'" href="'+app.url+'" ><span class="icon '+app.title.toLowerCase()+'" title="'+app.title+'" style="background-image: url(\''+app.iconUrl+'\');"></span></a>';
        applications.append(appTag);
    }*/
    updateApplications(configArray);
    // We update the size of the applications block
    updateBoxSize(maxApps);
    /*
    //We add special features to the icons if there are services to call/execute in the configuration JSON file
    // TODO : Slef-genereating arrays
    var casServices = [];
    var zimbraServices = [];
    var zcs_personnelServices = [];
    var zcs_etudiantServices = [];
    for(var i = 0; i<services.length; i++){
        var service = services[i];
        var auth = service.auth || null
        if (auth === "casZCS_personnel"){
            zcs_personnelServices.push(service);
        }else if(auth === "casZCS_etudiant"){
            zcs_etudiantServices.push(service);
        }else if(auth === "casZimbra"){
            zimbraServices.push(service);
        }else if(auth === "cas"){
            casServices.push(service);
        }else{
            var refreshTime = service.refreshTime;
            switch(service.name) { // Executes services that don't require authentification
                case "connexion":
                    tryConnexion("img/connexion.png", configArray);
                    console.log(refreshTime);
                    if(refreshTime > 0){ // If the attribute refreshTime exists, we execute the service every refreshTime seconds
                        $(document).ready(function() {
                            setInterval(tryConnexion,refreshTime,'img/connexion.png', configArray);
                        });
                    }
                    break;
                default:
                    console.log("Unknown service");
            }
        }
    }
    if(casServices.length !== 0) authCas("cas", casServices);
    if(zcs_personnelServices.length !== 0) authCas("zcs_personnel", zcs_personnelServices);
    if(zcs_etudiantServices.length !== 0) authCas("zcs_etudiant", zcs_etudiantServices);
    if(zimbraServices.length !== 0) authCas("zimbra", zimbraServices);
    */
}

/***********************************************
--------------------Services--------------------
***********************************************/

/**
* Tries to authentificate the user for a particular service
* /!\ Due to CAS redirections, authentification succedes when the ajax call gets an error /!\
* @authName : String which is the name of the service
* @authServices : JSON object that contains the details of the service. It can be handed to the service function if needed
**/
function authCas(authName, authServices){
    var urlCAS = "";
    if(authName === ""){

    }else if(authName === "zimbra")
        urlCAS = "https://auth.univ-lorraine.fr/login?service=https%3A%2F%2Fmail.univ-lorraine.fr%2Fzimbra%2Fpreauth%2FpreauthUL_PERS.jsp";
    else if(authName === "zcs_personnel")
        urlCAS = "https://auth.univ-lorraine.fr/login?service=https%3A%2F%2Fauth-zcs.univ-lorraine.fr%2Funiv-lorraine.fr.token-json";
    else if(authName === "zcs_etudiant")
        urlCAS = "https://auth.univ-lorraine.fr/login?service=https%3A%2F%2Fauth-zcs.univ-lorraine.fr%2Fetu.univ-lorraine.fr.token-json";
    ajaxPerso(urlCAS,
        function(data){
            console.log("You need to connect to CAS");
        },
        function(){
            for(var i = 0; i < authServices.length; i++){
                var service = authServices[ i ];
                switch(service.name){ // Executes services that have successfuly authentificated
                case "zimbra":
                    var refreshTime = service.refreshTime || 300000;
                    getZimbraData();
                    if(refreshTime > 0){ // If the attribute refreshTime exists, we execute the service every refreshTime seconds
                        $(document).ready(function(){
                            setInterval("getZimbraData()", refreshTime);
                        });
                    }
                    break;
                case "addApps":
                    if(authName === "zcs_personnel")
                        addApps("personnel", service);
                        else if(authName === "zcs_etudiant")
                            addApps("etudiant", service);
                    break;
                default:
                    console.log("Unknown service");
                };

            }
        }
    );
}

/**
* Zimbra service
* Add unread messages number to Messagerie icon
* Add following week appointments number to Planning icon
**/
function getZimbraData(){
    var urlZimbra = "https://mail.univ-lorraine.fr/home/~/";
    var urlToMessage = urlZimbra + ".json?query=is:unread%20-in:sent%20-in:trash%20-in:junk";
    if($("#ns-widget .messagerie")){
        ajaxPerso(urlToMessage,
            function(data){
                var unreadMessages = JSON.parse(data).m;
                if(unreadMessages){
                    var messagerie = $("#ns-widget .messagerie");
                    var nbr = (unreadMessages.length < 99) ? unreadMessages.length : "+99";
                    var unreadNumber = "<span class='number'>" + nbr + "</span>";
                    messagerie.attr("title", "Messagerie : " + nbr + " message(s) non lu(s)");
                    var existingNumber = $("#ns-widget .messagerie .number");
                    if(existingNumber.length === 0)
                        messagerie.append(unreadNumber);
                    else
                        existingNumber.replaceWith(unreadNumber);
                }else{
                    console.log("no messages");
                }
            },
            function(){
                console.log("Failed connexion to Zimbra (Messagerie)");
            }
        );
    }

    if($("#ns-widget .planning")){
        //urlToAppointment = 'http://localhost/zimbra_widget/proxy.php?'+'account='+data.account+'&token='+data.token+'&object='+'appointment'+'&query='+'';
        urlToAppointment = urlZimbra + "calendar.json?start=1day&end=2y";
        ajaxPerso(urlToAppointment,
            function(data){
                var soonAppointments = JSON.parse(data).appt;
                if(soonAppointments){
                    var planning = $("#ns-widget .planning");
                    var nbr = (soonAppointments.length < 99) ? soonAppointments.length : "+99";
                    var soonNumber = "<span class='number'>" + nbr + "</span>";
                    planning.attr("title", "Planning : " + nbr + " rendez-vous dans les 7 prochains jours");
                    var existingNumber = $("#ns-widget .planning .number");
                    if(existingNumber.length === 0)
                        planning.append(soonNumber);
                    else
                        existingNumber.replaceWith(soonNumber);
                }else{
                    console.log("no appointments");
                }
            },
            function(){
                console.log("Failed connexion to Zimbra (Planning)");
            }
        );
    }
}

/**
* AddApps service
* Add application's icons to nineSquare
* @target : String which tells if the icons must be added to a student or a personnel of Université de Lorraine
* @service : JSON object that contains the details of the addApps service. It contains the apps to be added (with an option whether to put it at the beginning or at the end of the already present apps)
**/
function addApps(target, service){
    var urlZcs = "";
    if(target === "personnel")
        urlZcs = "https://auth-zcs.univ-lorraine.fr/univ-lorraine.fr.token-json";
    else if(target === "etudiant")
        urlZcs = "https://auth-zcs.univ-lorraine.fr/etu.univ-lorraine.fr.token-json";
    var service = service || {};
    ajaxPerso(urlZcs,
        function(data){
            applications = $("#ns-widget .applications");
            var apps = service.apps;
            var app = {};
            for(var i = 0; i < apps.length; i++){
                app = apps[ i ];
                var appTag = "<a class=\"vignette\" title=\"" + app.title + "\" href=\"" + app.url + "\" ><span class=\"icon " + app.title.toLowerCase() + "\" title=\"" + app.title + "\" style=\"background-image: url('" + app.iconUrl + "');\"></span></a>";
                if(app.end)
                    applications.append(appTag);
                else
                    applications.prepend(appTag);
            }
            //TODO : Remove magic number
            updateBoxSize(window.nswidget.maxApps);
        },
        function(){
            console.log("Failed connexion to ZCS");
        }
    );
}

/**
* tryConnexion service
* Try to connect to CAS and put a lock icon on if it fails. Remove it when it succeeds
* @iconUrl : String which corresponds to the url to the lock icon
* @configArray : JSON object that contains the details of the widget. It contains all the apps and services. It will be used to update the application when there is a state change
**/
function tryConnexion(iconUrl, configArray){
    var urlCAS = "https://auth.univ-lorraine.fr/login?service=https%3A%2F%2Fmail.univ-lorraine.fr%2Fzimbra%2Fpreauth%2FpreauthUL_PERS.jsp";
    ajaxPerso(urlCAS,
        function(data){
            if($("#ns-widget .lock").length < 1){
                var appButton = $("#ns-widget .icon.app-button");
                var lock = "<span class=\"lock\"><img src=\"" + iconUrl + "\"></span>";
                appButton.prepend(lock);
                updateApplications(configArray);
            }
        },
        function(){
            var lock = $("#ns-widget .lock");
            if(lock.length >= 1){
                lock.remove();
                updateApplications(configArray);
            }
            console.log("You are connected to CAS");
        }
    );

}

/********************************************************
--------------------Utility functions--------------------
********************************************************/

function ajaxPerso(url, success, error){
    window.nswidget.ajaxCount++;
    checkOngoingAjax();
    $.ajax({
        type: "GET",
        url: url,
        contentType: "text/plain",
        crossDomain: true,
        xhrFields: {
            withCredentials: true
        },
        headers: {
            // Set any custom headers here.
            // If you set any non-simple headers, your server must include these
            // headers in the 'Access-Control-Allow-Headers' response header.
        },
        success: function(data){
            success(data);
            window.nswidget.ajaxCount--;
            checkOngoingAjax();
        },
        error: function(){
            error();
            window.nswidget.ajaxCount--;
            checkOngoingAjax();
        }
    });
}

function updateBoxSize(maxApps){
    var maxApps = maxApps || 9;
    var applicationsWidget = $("#ns-widget");
    var applications = $("#ns-widget .applications");
    var nbrApps = $("#ns-widget .vignette").length;
    var boxHeight = (maxApps > nbrApps) ? 70 * Math.ceil(nbrApps / 3) + 6 : 70 * Math.ceil(maxApps / 3) + 6; // Icon height * (row number) + 6 border widths
    if(boxHeight <= 6){
        boxHeight = 216;
    }
    applications.css("height", boxHeight);
    /**
        If there are more applications than the maximum value, we add a "Plus d'aplications" ("More applications") button
    **/
    if(nbrApps > maxApps){
        var display = applications.css("display");
        var plusButton = "<div class=\"plus-button\" style=\"display:" + display + ";\"><a href=\"\" onclick=\"return false;\">Plus d'applications</a></div>";
        applicationsWidget.append(plusButton);
        plusButton = $("#ns-widget .plus-button");
        plusButton.css("margin-top", boxHeight + 10 + 1); // plus-button offset = applications box height + applications box margin-top + 1

        // We add an event to toggle plusButton when we click on ns-icon with the applications block
        appButton = $("#ns-widget .app-button").click(function(){
            plusButton.toggle(0);
        });
        $(document).on("click", function(event){
            if(!$(event.target).closest(applications).length && !$(event.target).closest(appButton).length && !$(event.target).closest(".plus-button").length){
                plusButton.hide(0);
            }
        });
        var offset = appButton.offset().left;
        plusButton.css("margin-left", offset - 183 + 26); // button x coordinate - (applications block size)/2 + (button size/2)
        /**
        If someone click on "Plus d'applications", we change it to "Moins d'applications" ("Less applications")
        We also transform the applications block : overflow "hidden" to overflow "auto" which makes a scrollbar appear
        When you click on "Moins d'applications", the changes are reverted
        **/
        plusButton.children().on("click", function(){
            var boxWidth;
            if(applications.css("overflow") === "hidden"){
                boxWidth = applications.css("width");
                boxWidth = Math.round(boxWidth.substr(0, boxWidth.length - 2)) + 17; // If there are more applications than we want to show, a scrollbar will appear (overflow:auto) so we just add a scrollbar's width to the applications' box width
                applications.css("width", boxWidth);
                plusButton.css("width", boxWidth);
                applications.css("overflow", "auto");
                plusButton.children().html("Moins d'applications");
            }else if(applications.css("overflow") === "auto"){
                applications.scrollTop("0");
                boxWidth = applications.css("width");
                boxWidth = Math.round(boxWidth.substr(0, boxWidth.length - 2)) - 17; // If there are more applications than we want to show, a scrollbar will appear (overflow:auto) so we just add a scrollbar's width to the applications' box width
                applications.css("width", boxWidth);
                plusButton.css("width", boxWidth);
                applications.css("overflow", "hidden");
                plusButton.children().html("Plus d'applications");
            }
        });

    }
}

function updateApplications(configArray){
    var apps = configArray.apps;
    var services = configArray.services;
    var applications = $("#ns-widget .applications");
    var nbrApps = apps.length;

    // If there are icons, we remove them and create totally new ones
    $("#ns-widget a.vignette").remove();

    // We create the clickable icons with the configuration JSON file
    for(var i = 0; i < nbrApps; i++){
        var app = apps[ i ];
        var appTag = "<a class=\"vignette\" title=\"" + app.title + "\" href=\"" + app.url + "\" ><span class=\"icon " + app.title.toLowerCase() + "\" title=\"" + app.title + "\" style=\"background-image: url('" + app.iconUrl + "');\"></span></a>";
        applications.append(appTag);
    }

    //We add special features to the icons if there are services to call/execute in the configuration JSON file
    // TODO : Slef-genereating arrays
    var casServices = [];
    var zimbraServices = [];
    var zcs_personnelServices = [];
    var zcs_etudiantServices = [];
    for(var i = 0; i < services.length; i++){
        var service = services[ i ];
        var auth = service.auth || null;
        if(auth === "casZCS_personnel"){
            zcs_personnelServices.push(service);
        }else if(auth === "casZCS_etudiant"){
            zcs_etudiantServices.push(service);
        }else if(auth === "casZimbra"){
            zimbraServices.push(service);
        }else if(auth === "cas"){
            casServices.push(service);
        }else{
            var refreshTime = service.refreshTime;
            switch(service.name){ // Executes services that don't require authentification
            case "connexion":
                tryConnexion("img/connexion.png", configArray);
                if(refreshTime > 0){ // If the attribute refreshTime exists, we execute the service every refreshTime seconds
                    $(document).ready(function(){
                        setInterval(tryConnexion, refreshTime, "img/connexion.png", configArray);
                    });
                }
                break;
            default:
                console.log("Unknown service");
            }
        }
    }
    if(casServices.length !== 0) authCas("cas", casServices);
    if(zcs_personnelServices.length !== 0) authCas("zcs_personnel", zcs_personnelServices);
    if(zcs_etudiantServices.length !== 0) authCas("zcs_etudiant", zcs_etudiantServices);
    if(zimbraServices.length !== 0) authCas("zimbra", zimbraServices);
}

function checkOngoingAjax(){
    var loader = $(".loader img");
    if(window.nswidget.ajaxCount > 0){
        loader.css("display", "inline-block");
    }else{
        loader.css("display", "none");
    }
}