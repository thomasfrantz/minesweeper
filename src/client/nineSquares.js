/**<linter>
<lastLinted>22/02/2016 18:00<lastLinted>
<errorCount>286<errorCount>
<errors>
    func-names line 300 : Missing function expression name.
    newline-after-var line 301 : Expected blank line after variable declarations.
    valid-jsdoc line 311 : Missing JSDoc for parameter 'configArray'.
    no-unused-vars line 315 : "startNsWidget" is defined but never used
    no-unused-vars line 317 : "services" is defined but never used
    max-len line 328 : Line 328 exceeds the maximum line length of 80.
    vars-on-top line 328 : All "var" declarations must be at the top of the function scope.
    max-len line 329 : Line 329 exceeds the maximum line length of 80.
    vars-on-top line 329 : All "var" declarations must be at the top of the function scope.
    newline-after-var line 330 : Expected blank line after variable declarations.
    vars-on-top line 330 : All "var" declarations must be at the top of the function scope.
    id-length line 330 : Identifier name 'applicationsWidget' is too long. (> 15)
    no-undef line 330 : "$" is not defined.
    no-undef line 333 : "$" is not defined.
    vars-on-top line 334 : All "var" declarations must be at the top of the function scope.
    no-unused-vars line 334 : "nbrApps" is defined but never used
    no-undef line 338 : "$" is not defined.
    func-names line 338 : Missing function expression name.
    no-undef line 341 : "$" is not defined.
    func-names line 341 : Missing function expression name.
    no-shadow line 341 : "event" is already declared in the upper scope.
    max-len line 342 : Line 342 exceeds the maximum line length of 80.
    no-undef line 342 : "$" is not defined.
    no-undef line 342 : "$" is not defined.
    no-undef line 342 : "$" is not defined.
    vars-on-top line 348 : All "var" declarations must be at the top of the function scope.
    newline-after-var line 348 : Expected blank line after variable declarations.
    no-magic-numbers line 349 : No magic number: 183
    no-magic-numbers line 349 : No magic number: 26
    no-inline-comments line 349 : Unexpected comment inline with code.
    lines-around-comment line 360 : Expected line before comment.
    valid-jsdoc line 406 : Missing JSDoc for parameter 'authName'.
    valid-jsdoc line 406 : Missing JSDoc for parameter 'authServices'.
    newline-after-var line 413 : Expected blank line after variable declarations.
    no-empty line 414 : Empty block statement.
    curly line 416 : Expected { after 'if' condition.
    curly line 418 : Expected { after 'if' condition.
    curly line 420 : Expected { after 'if' condition.
    func-names line 423 : Missing function expression name.
    no-unused-vars line 423 : "data" is defined but never used
    func-names line 426 : Missing function expression name.
    no-inner-declarations line 427 : Move variable declaration to function body root.
    vars-on-top line 427 : All "var" declarations must be at the top of the function scope.
    no-inner-declarations line 428 : Move variable declaration to function body root.
    vars-on-top line 428 : All "var" declarations must be at the top of the function scope.
    newline-after-var line 428 : Expected blank line after variable declarations.
    no-inline-comments line 429 : Unexpected comment inline with code.
    no-inner-declarations line 431 : Move variable declaration to function body root.
    vars-on-top line 431 : All "var" declarations must be at the top of the function scope.
    newline-after-var line 431 : Expected blank line after variable declarations.
    no-magic-numbers line 431 : No magic number: 300000
    no-inline-comments line 433 : Unexpected comment inline with code.
    no-undef line 434 : "$" is not defined.
    func-names line 434 : Missing function expression name.
    no-loop-func line 434 : Don't make functions within a loop
    no-implied-eval line 435 : Implied eval. Consider passing a function instead of a string.
    curly line 440 : Expected { after 'if' condition.
    curly line 442 : Expected { after 'if' condition.
    padded-blocks line 449 : Block must not be padded by blank lines.
    max-len line 461 : Line 461 exceeds the maximum line length of 80.
    newline-after-var line 461 : Expected blank line after variable declarations.
    no-undef line 462 : "$" is not defined.
    func-names line 464 : Missing function expression name.
    newline-after-var line 465 : Expected blank line after variable declarations.
    no-inner-declarations line 467 : Move variable declaration to function body root.
    vars-on-top line 467 : All "var" declarations must be at the top of the function scope.
    no-undef line 467 : "$" is not defined.
    max-len line 468 : Line 468 exceeds the maximum line length of 80.
    vars-on-top line 468 : All "var" declarations must be at the top of the function scope.
    no-inner-declarations line 468 : Move variable declaration to function body root.
    no-extra-parens line 468 : Gratuitous parentheses around expression.
    no-magic-numbers line 468 : No magic number: 99
    max-len line 469 : Line 469 exceeds the maximum line length of 80.
    no-inner-declarations line 469 : Move variable declaration to function body root.
    vars-on-top line 469 : All "var" declarations must be at the top of the function scope.
    newline-after-var line 469 : Expected blank line after variable declarations.
    max-len line 470 : Line 470 exceeds the maximum line length of 80.
    no-inner-declarations line 471 : Move variable declaration to function body root.
    vars-on-top line 471 : All "var" declarations must be at the top of the function scope.
    newline-after-var line 471 : Expected blank line after variable declarations.
    no-undef line 471 : "$" is not defined.
    curly line 472 : Expected { after 'if' condition.
    curly line 474 : Expected { after 'else'.
    func-names line 480 : Missing function expression name.
    no-undef line 486 : "$" is not defined.
    no-undef line 488 : "urlToAppointment" is not defined.
    no-undef line 489 : "urlToAppointment" is not defined.
    func-names line 490 : Missing function expression name.
    newline-after-var line 491 : Expected blank line after variable declarations.
    id-length line 491 : Identifier name 'soonAppointments' is too long. (> 15)
    no-inner-declarations line 493 : Move variable declaration to function body root.
    vars-on-top line 493 : All "var" declarations must be at the top of the function scope.
    no-undef line 493 : "$" is not defined.
    max-len line 494 : Line 494 exceeds the maximum line length of 80.
    vars-on-top line 494 : All "var" declarations must be at the top of the function scope.
    no-inner-declarations line 494 : Move variable declaration to function body root.
    no-extra-parens line 494 : Gratuitous parentheses around expression.
    id-length line 494 : Identifier name 'soonAppointments' is too long. (> 15)
    no-magic-numbers line 494 : No magic number: 99
    no-inner-declarations line 495 : Move variable declaration to function body root.
    vars-on-top line 495 : All "var" declarations must be at the top of the function scope.
    newline-after-var line 495 : Expected blank line after variable declarations.
    max-len line 496 : Line 496 exceeds the maximum line length of 80.
    no-inner-declarations line 497 : Move variable declaration to function body root.
    vars-on-top line 497 : All "var" declarations must be at the top of the function scope.
    newline-after-var line 497 : Expected blank line after variable declarations.
    no-undef line 497 : "$" is not defined.
    curly line 498 : Expected { after 'if' condition.
    curly line 500 : Expected { after 'else'.
    func-names line 506 : Missing function expression name.
    valid-jsdoc line 513 : Missing JSDoc for parameter 'target'.
    valid-jsdoc line 513 : Missing JSDoc for parameter 'service'.
    newline-after-var line 520 : Expected blank line after variable declarations.
    curly line 521 : Expected { after 'if' condition.
    curly line 523 : Expected { after 'if' condition.
    newline-after-var line 525 : Expected blank line after variable declarations.
    vars-on-top line 525 : All "var" declarations must be at the top of the function scope.
    no-redeclare line 525 : "service" is already defined
    func-names line 527 : Missing function expression name.
    no-unused-vars line 527 : "data" is defined but never used
    no-undef line 528 : "applications" is not defined.
    no-undef line 528 : "$" is not defined.
    vars-on-top line 529 : All "var" declarations must be at the top of the function scope.
    newline-after-var line 530 : Expected blank line after variable declarations.
    vars-on-top line 530 : All "var" declarations must be at the top of the function scope.
    no-inner-declarations line 531 : Move variable declaration to function body root.
    vars-on-top line 531 : All "var" declarations must be at the top of the function scope.
    max-len line 533 : Line 533 exceeds the maximum line length of 80.
    no-inner-declarations line 533 : Move variable declaration to function body root.
    vars-on-top line 533 : All "var" declarations must be at the top of the function scope.
    newline-after-var line 533 : Expected blank line after variable declarations.
    curly line 534 : Expected { after 'if' condition.
    no-undef line 535 : "applications" is not defined.
    curly line 536 : Expected { after 'else'.
    no-undef line 537 : "applications" is not defined.
    func-names line 542 : Missing function expression name.
    valid-jsdoc line 548 : Missing JSDoc for parameter 'configArray'.
    valid-jsdoc line 548 : Missing JSDoc for parameter 'iconUrl'.
    newline-after-var line 555 : Expected blank line after variable declarations.
    func-names line 557 : Missing function expression name.
    no-unused-vars line 557 : "data" is defined but never used
    no-undef line 558 : "$" is not defined.
    no-inner-declarations line 559 : Move variable declaration to function body root.
    vars-on-top line 559 : All "var" declarations must be at the top of the function scope.
    no-undef line 559 : "$" is not defined.
    max-len line 560 : Line 560 exceeds the maximum line length of 80.
    vars-on-top line 560 : All "var" declarations must be at the top of the function scope.
    newline-after-var line 560 : Expected blank line after variable declarations.
    no-inner-declarations line 560 : Move variable declaration to function body root.
    func-names line 565 : Missing function expression name.
    newline-after-var line 566 : Expected blank line after variable declarations.
    no-undef line 566 : "$" is not defined.
    padded-blocks line 575 : Block must not be padded by blank lines.
    require-jsdoc line 581 : Missing JSDoc comment.
    no-undef line 584 : "$" is not defined.
    quote-props line 585 : Unquoted property `type` found.
    key-spacing line 585 : Missing space before value for key "type".
    quote-props line 586 : Unquoted property `url` found.
    key-spacing line 586 : Missing space before value for key "url".
    quote-props line 587 : Unquoted property `contentType` found.
    quote-props line 588 : Unquoted property `crossDomain` found.
    quote-props line 589 : Unquoted property `xhrFields` found.
    key-spacing line 589 : Missing space before value for key "xhrFields".
    quote-props line 590 : Unquoted property `withCredentials` found.
    quote-props line 592 : Unquoted property `headers` found.
    quote-props line 597 : Unquoted property `success` found.
    func-names line 597 : Missing function expression name.
    quote-props line 602 : Unquoted property `error` found.
    func-names line 602 : Missing function expression name.
    require-jsdoc line 610 : Missing JSDoc comment.
    no-redeclare line 611 : "maxApps" is already defined
    no-magic-numbers line 611 : No magic number: 9
    id-length line 612 : Identifier name 'applicationsWidget' is too long. (> 15)
    no-undef line 612 : "$" is not defined.
    no-undef line 613 : "$" is not defined.
    no-undef line 614 : "$" is not defined.
    max-len line 615 : Line 615 exceeds the maximum line length of 80.
    newline-after-var line 615 : Expected blank line after variable declarations.
    no-extra-parens line 615 : Gratuitous parentheses around expression.
    no-magic-numbers line 615 : No magic number: 70
    no-magic-numbers line 615 : No magic number: 3
    no-magic-numbers line 615 : No magic number: 6
    no-magic-numbers line 615 : No magic number: 70
    no-magic-numbers line 615 : No magic number: 3
    no-magic-numbers line 615 : No magic number: 6
    no-inline-comments line 615 : Unexpected comment inline with code.
    no-magic-numbers line 616 : No magic number: 6
    lines-around-comment line 620 : Expected line before comment.
    no-inner-declarations line 624 : Move variable declaration to function body root.
    vars-on-top line 624 : All "var" declarations must be at the top of the function scope.
    max-len line 625 : Line 625 exceeds the maximum line length of 80.
    vars-on-top line 625 : All "var" declarations must be at the top of the function scope.
    no-inner-declarations line 625 : Move variable declaration to function body root.
    newline-after-var line 625 : Expected blank line after variable declarations.
    no-undef line 627 : "$" is not defined.
    no-magic-numbers line 628 : No magic number: 10
    no-inline-comments line 628 : Unexpected comment inline with code.
    no-undef line 631 : "appButton" is not defined.
    no-undef line 631 : "$" is not defined.
    func-names line 631 : Missing function expression name.
    no-undef line 634 : "$" is not defined.
    func-names line 634 : Missing function expression name.
    no-shadow line 634 : "event" is already declared in the upper scope.
    max-len line 635 : Line 635 exceeds the maximum line length of 80.
    no-undef line 635 : "$" is not defined.
    no-undef line 635 : "$" is not defined.
    no-undef line 635 : "appButton" is not defined.
    no-undef line 635 : "$" is not defined.
    no-inner-declarations line 639 : Move variable declaration to function body root.
    vars-on-top line 639 : All "var" declarations must be at the top of the function scope.
    newline-after-var line 639 : Expected blank line after variable declarations.
    no-undef line 639 : "appButton" is not defined.
    no-magic-numbers line 640 : No magic number: 183
    no-magic-numbers line 640 : No magic number: 26
    no-inline-comments line 640 : Unexpected comment inline with code.
    func-names line 646 : Missing function expression name.
    newline-after-var line 647 : Expected blank line after variable declarations.
    max-len line 650 : Line 650 exceeds the maximum line length of 80.
    no-magic-numbers line 650 : No magic number: 17
    no-inline-comments line 650 : Unexpected comment inline with code.
    max-len line 658 : Line 658 exceeds the maximum line length of 80.
    no-magic-numbers line 658 : No magic number: 17
    no-inline-comments line 658 : Unexpected comment inline with code.
    padded-blocks line 666 : Block must not be padded by blank lines.
    require-jsdoc line 669 : Missing JSDoc comment.
    id-length line 669 : Identifier name 'updateApplications' is too long. (> 15)
    no-undef line 672 : "$" is not defined.
    no-undef line 676 : "$" is not defined.
    no-inner-declarations line 679 : Move variable declaration to function body root.
    vars-on-top line 679 : All "var" declarations must be at the top of the function scope.
    block-scoped-var line 679 : "i" used outside of binding context.
    block-scoped-var line 679 : "i" used outside of binding context.
    block-scoped-var line 679 : "i" used outside of binding context.
    no-inner-declarations line 680 : Move variable declaration to function body root.
    vars-on-top line 680 : All "var" declarations must be at the top of the function scope.
    block-scoped-var line 680 : "i" used outside of binding context.
    max-len line 681 : Line 681 exceeds the maximum line length of 80.
    no-inner-declarations line 681 : Move variable declaration to function body root.
    vars-on-top line 681 : All "var" declarations must be at the top of the function scope.
    newline-after-var line 681 : Expected blank line after variable declarations.
    vars-on-top line 687 : All "var" declarations must be at the top of the function scope.
    vars-on-top line 688 : All "var" declarations must be at the top of the function scope.
    vars-on-top line 689 : All "var" declarations must be at the top of the function scope.
    id-length line 689 : Identifier name 'zcs_personnelServices' is too long. (> 15)
    camelcase line 689 : Identifier 'zcs_personnelServices' is not in camel case.
    vars-on-top line 690 : All "var" declarations must be at the top of the function scope.
    newline-after-var line 690 : Expected blank line after variable declarations.
    id-length line 690 : Identifier name 'zcs_etudiantServices' is too long. (> 15)
    camelcase line 690 : Identifier 'zcs_etudiantServices' is not in camel case.
    no-inner-declarations line 691 : Move variable declaration to function body root.
    vars-on-top line 691 : All "var" declarations must be at the top of the function scope.
    block-scoped-var line 691 : "i" used outside of binding context.
    no-redeclare line 691 : "i" is already defined
    block-scoped-var line 691 : "i" used outside of binding context.
    block-scoped-var line 691 : "i" used outside of binding context.
    no-inner-declarations line 692 : Move variable declaration to function body root.
    vars-on-top line 692 : All "var" declarations must be at the top of the function scope.
    block-scoped-var line 692 : "i" used outside of binding context.
    vars-on-top line 693 : All "var" declarations must be at the top of the function scope.
    newline-after-var line 693 : Expected blank line after variable declarations.
    no-inner-declarations line 693 : Move variable declaration to function body root.
    camelcase line 695 : Identifier 'zcs_personnelServices' is not in camel case.
    camelcase line 697 : Identifier 'zcs_etudiantServices' is not in camel case.
    no-inner-declarations line 703 : Move variable declaration to function body root.
    vars-on-top line 703 : All "var" declarations must be at the top of the function scope.
    newline-after-var line 703 : Expected blank line after variable declarations.
    no-inline-comments line 704 : Unexpected comment inline with code.
    no-inline-comments line 707 : Unexpected comment inline with code.
    no-undef line 708 : "$" is not defined.
    no-loop-func line 708 : Don't make functions within a loop
    func-names line 708 : Missing function expression name.
    max-len line 709 : Line 709 exceeds the maximum line length of 80.
    curly line 718 : Expected { after 'if' condition.
    max-len line 719 : Line 719 exceeds the maximum line length of 80.
    curly line 719 : Expected { after 'if' condition.
    camelcase line 719 : Identifier 'zcs_personnelServices' is not in camel case.
    id-length line 719 : Identifier name 'zcs_personnelServices' is too long. (> 15)
    max-len line 720 : Line 720 exceeds the maximum line length of 80.
    curly line 720 : Expected { after 'if' condition.
    camelcase line 720 : Identifier 'zcs_etudiantServices' is not in camel case.
    id-length line 720 : Identifier name 'zcs_etudiantServices' is too long. (> 15)
    curly line 721 : Expected { after 'if' condition.
    require-jsdoc line 724 : Missing JSDoc comment.
    id-length line 724 : Identifier name 'checkOngoingAjax' is too long. (> 15)
    newline-after-var line 725 : Expected blank line after variable declarations.
    no-undef line 725 : "$" is not defined.
<errors>
<linter>**/

/*************************************************
--------------------CSS Import--------------------
*************************************************/

[
    "nineSquares.css"
].forEach(function(href){
    var link = document.createElement("link");
    link.rel = "stylesheet";
    link.href = href;
    document.head.appendChild(link);
});

/*******************************************
--------------------Main--------------------
*******************************************/

/**
* Append a 9 squares button and a list of icons in the #applications-widget div
* @configArray : JSON file that is used to configure the widget
**/
function startNsWidget(configArray){
    var apps = configArray.apps;
    var services = configArray.services;
    var maxApps = configArray.maxApps;
    var mainIconUrl = configArray.mainIconUrl;
    var loadingIconUrl = configArray.loadingIconUrl;

    // We need maxApps and ajaxCount to be global :/
    window.nswidget = {};
    window.nswidget.maxApps = maxApps;
    window.nswidget.ajaxCount = 0;

    // First we add the 9 squares button, then the block we'll put the apps in. The applications block is not visible at first
    var appButton = "<div class=\"icon app-button\" style=\"margin-left:500px;background-image: url('" + mainIconUrl + "');\"><span class=\"loader\"><img src='" + loadingIconUrl + "' style=\"display:none;\"></span></div>";
    var applications = "<div class=\"applications\" style=\"display:none;\"></div>";
    var applicationsWidget = $("#ns-widget");
    applicationsWidget.append(appButton);
    applicationsWidget.append(applications);
    applications = $("#ns-widget .applications");
    var nbrApps = apps.length;

    // We add a click event on the button : toggle the applications block
    // We also make the applications block disapear if we click outside of it
    appButton = $("#ns-widget .app-button").click(function(){
        applications.toggle(0);
    });
    $(document).on("click", function(event){
        if(!$(event.target).closest(applications).length && !$(event.target).closest(appButton).length && !$(event.target).closest(".plus-button").length){
            applications.hide(0);
        }
    });

    // We put the applications block under the button
    var offset = appButton.offset().left;
    applications.css("margin-left", offset - 183 + 26); // button x coordinate - (applications block size)/2 + (button size/2)
    /*
    // We create the clickable icons with the configuration JSON file
    for(var i=0; i<nbrApps; i++){
        var app = apps[i];
        var appTag = '<a class="vignette" title="'+app.title+'" href="'+app.url+'" ><span class="icon '+app.title.toLowerCase()+'" title="'+app.title+'" style="background-image: url(\''+app.iconUrl+'\');"></span></a>';
        applications.append(appTag);
    }*/
    updateApplications(configArray);
    // We update the size of the applications block
    updateBoxSize(maxApps);
    /*
    //We add special features to the icons if there are services to call/execute in the configuration JSON file
    // TODO : Slef-genereating arrays
    var casServices = [];
    var zimbraServices = [];
    var zcs_personnelServices = [];
    var zcs_etudiantServices = [];
    for(var i = 0; i<services.length; i++){
        var service = services[i];
        var auth = service.auth || null
        if (auth === "casZCS_personnel"){
            zcs_personnelServices.push(service);
        }else if(auth === "casZCS_etudiant"){
            zcs_etudiantServices.push(service);
        }else if(auth === "casZimbra"){
            zimbraServices.push(service);
        }else if(auth === "cas"){
            casServices.push(service);
        }else{
            var refreshTime = service.refreshTime;
            switch(service.name) { // Executes services that don't require authentification
                case "connexion":
                    tryConnexion("img/connexion.png", configArray);
                    console.log(refreshTime);
                    if(refreshTime > 0){ // If the attribute refreshTime exists, we execute the service every refreshTime seconds
                        $(document).ready(function() {
                            setInterval(tryConnexion,refreshTime,'img/connexion.png', configArray);
                        });
                    }
                    break;
                default:
                    console.log("Unknown service");
            }
        }
    }
    if(casServices.length !== 0) authCas("cas", casServices);
    if(zcs_personnelServices.length !== 0) authCas("zcs_personnel", zcs_personnelServices);
    if(zcs_etudiantServices.length !== 0) authCas("zcs_etudiant", zcs_etudiantServices);
    if(zimbraServices.length !== 0) authCas("zimbra", zimbraServices);
    */
}

/***********************************************
--------------------Services--------------------
***********************************************/

/**
* Tries to authentificate the user for a particular service
* /!\ Due to CAS redirections, authentification succedes when the ajax call gets an error /!\
* @authName : String which is the name of the service
* @authServices : JSON object that contains the details of the service. It can be handed to the service function if needed
**/
function authCas(authName, authServices){
    var urlCAS = "";
    if(authName === ""){

    }else if(authName === "zimbra")
        urlCAS = "https://auth.univ-lorraine.fr/login?service=https%3A%2F%2Fmail.univ-lorraine.fr%2Fzimbra%2Fpreauth%2FpreauthUL_PERS.jsp";
    else if(authName === "zcs_personnel")
        urlCAS = "https://auth.univ-lorraine.fr/login?service=https%3A%2F%2Fauth-zcs.univ-lorraine.fr%2Funiv-lorraine.fr.token-json";
    else if(authName === "zcs_etudiant")
        urlCAS = "https://auth.univ-lorraine.fr/login?service=https%3A%2F%2Fauth-zcs.univ-lorraine.fr%2Fetu.univ-lorraine.fr.token-json";
    ajaxPerso(urlCAS,
        function(data){
            console.log("You need to connect to CAS");
        },
        function(){
            for(var i = 0; i < authServices.length; i++){
                var service = authServices[ i ];
                switch(service.name){ // Executes services that have successfuly authentificated
                case "zimbra":
                    var refreshTime = service.refreshTime || 300000;
                    getZimbraData();
                    if(refreshTime > 0){ // If the attribute refreshTime exists, we execute the service every refreshTime seconds
                        $(document).ready(function(){
                            setInterval("getZimbraData()", refreshTime);
                        });
                    }
                    break;
                case "addApps":
                    if(authName === "zcs_personnel")
                        addApps("personnel", service);
                        else if(authName === "zcs_etudiant")
                            addApps("etudiant", service);
                    break;
                default:
                    console.log("Unknown service");
                };

            }
        }
    );
}

/**
* Zimbra service
* Add unread messages number to Messagerie icon
* Add following week appointments number to Planning icon
**/
function getZimbraData(){
    var urlZimbra = "https://mail.univ-lorraine.fr/home/~/";
    var urlToMessage = urlZimbra + ".json?query=is:unread%20-in:sent%20-in:trash%20-in:junk";
    if($("#ns-widget .messagerie")){
        ajaxPerso(urlToMessage,
            function(data){
                var unreadMessages = JSON.parse(data).m;
                if(unreadMessages){
                    var messagerie = $("#ns-widget .messagerie");
                    var nbr = (unreadMessages.length < 99) ? unreadMessages.length : "+99";
                    var unreadNumber = "<span class='number'>" + nbr + "</span>";
                    messagerie.attr("title", "Messagerie : " + nbr + " message(s) non lu(s)");
                    var existingNumber = $("#ns-widget .messagerie .number");
                    if(existingNumber.length === 0)
                        messagerie.append(unreadNumber);
                    else
                        existingNumber.replaceWith(unreadNumber);
                }else{
                    console.log("no messages");
                }
            },
            function(){
                console.log("Failed connexion to Zimbra (Messagerie)");
            }
        );
    }

    if($("#ns-widget .planning")){
        //urlToAppointment = 'http://localhost/zimbra_widget/proxy.php?'+'account='+data.account+'&token='+data.token+'&object='+'appointment'+'&query='+'';
        urlToAppointment = urlZimbra + "calendar.json?start=1day&end=2y";
        ajaxPerso(urlToAppointment,
            function(data){
                var soonAppointments = JSON.parse(data).appt;
                if(soonAppointments){
                    var planning = $("#ns-widget .planning");
                    var nbr = (soonAppointments.length < 99) ? soonAppointments.length : "+99";
                    var soonNumber = "<span class='number'>" + nbr + "</span>";
                    planning.attr("title", "Planning : " + nbr + " rendez-vous dans les 7 prochains jours");
                    var existingNumber = $("#ns-widget .planning .number");
                    if(existingNumber.length === 0)
                        planning.append(soonNumber);
                    else
                        existingNumber.replaceWith(soonNumber);
                }else{
                    console.log("no appointments");
                }
            },
            function(){
                console.log("Failed connexion to Zimbra (Planning)");
            }
        );
    }
}

/**
* AddApps service
* Add application's icons to nineSquare
* @target : String which tells if the icons must be added to a student or a personnel of Université de Lorraine
* @service : JSON object that contains the details of the addApps service. It contains the apps to be added (with an option whether to put it at the beginning or at the end of the already present apps)
**/
function addApps(target, service){
    var urlZcs = "";
    if(target === "personnel")
        urlZcs = "https://auth-zcs.univ-lorraine.fr/univ-lorraine.fr.token-json";
    else if(target === "etudiant")
        urlZcs = "https://auth-zcs.univ-lorraine.fr/etu.univ-lorraine.fr.token-json";
    var service = service || {};
    ajaxPerso(urlZcs,
        function(data){
            applications = $("#ns-widget .applications");
            var apps = service.apps;
            var app = {};
            for(var i = 0; i < apps.length; i++){
                app = apps[ i ];
                var appTag = "<a class=\"vignette\" title=\"" + app.title + "\" href=\"" + app.url + "\" ><span class=\"icon " + app.title.toLowerCase() + "\" title=\"" + app.title + "\" style=\"background-image: url('" + app.iconUrl + "');\"></span></a>";
                if(app.end)
                    applications.append(appTag);
                else
                    applications.prepend(appTag);
            }
            //TODO : Remove magic number
            updateBoxSize(window.nswidget.maxApps);
        },
        function(){
            console.log("Failed connexion to ZCS");
        }
    );
}

/**
* tryConnexion service
* Try to connect to CAS and put a lock icon on if it fails. Remove it when it succeeds
* @iconUrl : String which corresponds to the url to the lock icon
* @configArray : JSON object that contains the details of the widget. It contains all the apps and services. It will be used to update the application when there is a state change
**/
function tryConnexion(iconUrl, configArray){
    var urlCAS = "https://auth.univ-lorraine.fr/login?service=https%3A%2F%2Fmail.univ-lorraine.fr%2Fzimbra%2Fpreauth%2FpreauthUL_PERS.jsp";
    ajaxPerso(urlCAS,
        function(data){
            if($("#ns-widget .lock").length < 1){
                var appButton = $("#ns-widget .icon.app-button");
                var lock = "<span class=\"lock\"><img src=\"" + iconUrl + "\"></span>";
                appButton.prepend(lock);
                updateApplications(configArray);
            }
        },
        function(){
            var lock = $("#ns-widget .lock");
            if(lock.length >= 1){
                lock.remove();
                updateApplications(configArray);
            }
            console.log("You are connected to CAS");
        }
    );

}

/********************************************************
--------------------Utility functions--------------------
********************************************************/

function ajaxPerso(url, success, error){
    window.nswidget.ajaxCount++;
    checkOngoingAjax();
    $.ajax({
        type: "GET",
        url: url,
        contentType: "text/plain",
        crossDomain: true,
        xhrFields: {
            withCredentials: true
        },
        headers: {
            // Set any custom headers here.
            // If you set any non-simple headers, your server must include these
            // headers in the 'Access-Control-Allow-Headers' response header.
        },
        success: function(data){
            success(data);
            window.nswidget.ajaxCount--;
            checkOngoingAjax();
        },
        error: function(){
            error();
            window.nswidget.ajaxCount--;
            checkOngoingAjax();
        }
    });
}

function updateBoxSize(maxApps){
    var maxApps = maxApps || 9;
    var applicationsWidget = $("#ns-widget");
    var applications = $("#ns-widget .applications");
    var nbrApps = $("#ns-widget .vignette").length;
    var boxHeight = (maxApps > nbrApps) ? 70 * Math.ceil(nbrApps / 3) + 6 : 70 * Math.ceil(maxApps / 3) + 6; // Icon height * (row number) + 6 border widths
    if(boxHeight <= 6){
        boxHeight = 216;
    }
    applications.css("height", boxHeight);
    /**
        If there are more applications than the maximum value, we add a "Plus d'aplications" ("More applications") button
    **/
    if(nbrApps > maxApps){
        var display = applications.css("display");
        var plusButton = "<div class=\"plus-button\" style=\"display:" + display + ";\"><a href=\"\" onclick=\"return false;\">Plus d'applications</a></div>";
        applicationsWidget.append(plusButton);
        plusButton = $("#ns-widget .plus-button");
        plusButton.css("margin-top", boxHeight + 10 + 1); // plus-button offset = applications box height + applications box margin-top + 1

        // We add an event to toggle plusButton when we click on ns-icon with the applications block
        appButton = $("#ns-widget .app-button").click(function(){
            plusButton.toggle(0);
        });
        $(document).on("click", function(event){
            if(!$(event.target).closest(applications).length && !$(event.target).closest(appButton).length && !$(event.target).closest(".plus-button").length){
                plusButton.hide(0);
            }
        });
        var offset = appButton.offset().left;
        plusButton.css("margin-left", offset - 183 + 26); // button x coordinate - (applications block size)/2 + (button size/2)
        /**
        If someone click on "Plus d'applications", we change it to "Moins d'applications" ("Less applications")
        We also transform the applications block : overflow "hidden" to overflow "auto" which makes a scrollbar appear
        When you click on "Moins d'applications", the changes are reverted
        **/
        plusButton.children().on("click", function(){
            var boxWidth;
            if(applications.css("overflow") === "hidden"){
                boxWidth = applications.css("width");
                boxWidth = Math.round(boxWidth.substr(0, boxWidth.length - 2)) + 17; // If there are more applications than we want to show, a scrollbar will appear (overflow:auto) so we just add a scrollbar's width to the applications' box width
                applications.css("width", boxWidth);
                plusButton.css("width", boxWidth);
                applications.css("overflow", "auto");
                plusButton.children().html("Moins d'applications");
            }else if(applications.css("overflow") === "auto"){
                applications.scrollTop("0");
                boxWidth = applications.css("width");
                boxWidth = Math.round(boxWidth.substr(0, boxWidth.length - 2)) - 17; // If there are more applications than we want to show, a scrollbar will appear (overflow:auto) so we just add a scrollbar's width to the applications' box width
                applications.css("width", boxWidth);
                plusButton.css("width", boxWidth);
                applications.css("overflow", "hidden");
                plusButton.children().html("Plus d'applications");
            }
        });

    }
}

function updateApplications(configArray){
    var apps = configArray.apps;
    var services = configArray.services;
    var applications = $("#ns-widget .applications");
    var nbrApps = apps.length;

    // If there are icons, we remove them and create totally new ones
    $("#ns-widget a.vignette").remove();

    // We create the clickable icons with the configuration JSON file
    for(var i = 0; i < nbrApps; i++){
        var app = apps[ i ];
        var appTag = "<a class=\"vignette\" title=\"" + app.title + "\" href=\"" + app.url + "\" ><span class=\"icon " + app.title.toLowerCase() + "\" title=\"" + app.title + "\" style=\"background-image: url('" + app.iconUrl + "');\"></span></a>";
        applications.append(appTag);
    }

    //We add special features to the icons if there are services to call/execute in the configuration JSON file
    // TODO : Slef-genereating arrays
    var casServices = [];
    var zimbraServices = [];
    var zcs_personnelServices = [];
    var zcs_etudiantServices = [];
    for(var i = 0; i < services.length; i++){
        var service = services[ i ];
        var auth = service.auth || null;
        if(auth === "casZCS_personnel"){
            zcs_personnelServices.push(service);
        }else if(auth === "casZCS_etudiant"){
            zcs_etudiantServices.push(service);
        }else if(auth === "casZimbra"){
            zimbraServices.push(service);
        }else if(auth === "cas"){
            casServices.push(service);
        }else{
            var refreshTime = service.refreshTime;
            switch(service.name){ // Executes services that don't require authentification
            case "connexion":
                tryConnexion("img/connexion.png", configArray);
                if(refreshTime > 0){ // If the attribute refreshTime exists, we execute the service every refreshTime seconds
                    $(document).ready(function(){
                        setInterval(tryConnexion, refreshTime, "img/connexion.png", configArray);
                    });
                }
                break;
            default:
                console.log("Unknown service");
            }
        }
    }
    if(casServices.length !== 0) authCas("cas", casServices);
    if(zcs_personnelServices.length !== 0) authCas("zcs_personnel", zcs_personnelServices);
    if(zcs_etudiantServices.length !== 0) authCas("zcs_etudiant", zcs_etudiantServices);
    if(zimbraServices.length !== 0) authCas("zimbra", zimbraServices);
}

function checkOngoingAjax(){
    var loader = $(".loader img");
    if(window.nswidget.ajaxCount > 0){
        loader.css("display", "inline-block");
    }else{
        loader.css("display", "none");
    }
}